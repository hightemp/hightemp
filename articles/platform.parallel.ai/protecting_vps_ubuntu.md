Вот перевод статьи на русский язык:

# План защиты VPS на Ubuntu в первый день: от нуля до щита

## Краткое содержание
В этом отчете представлен всеобъемлющий, многоуровневый план по обеспечению безопасности недавно запущенного виртуального частного сервера (VPS) на Ubuntu. Новый сервер становится целью автоматических атак в течение нескольких минут после выхода в онлайн, что делает немедленную, систематическую защиту обязательным первым шагом. Следующие выводы суммируют наиболее важные действия и их стратегическое воздействие, переходя от первоначальной блокировки к постоянному, автоматизированному управлению состоянием безопасности.

### 24-часовая уязвимость требует немедленных действий
Автоматизированные боты начинают сканировать новые публичные IP-адреса в течение нескольких часов после их создания. Чтобы противостоять этому, необходимо немедленно выполнить **Комплексную последовательность первоначальной защиты**, состоящую из 6 шагов, чтобы резко сократить доступную поверхность атаки. Этот первичный план действий сокращает уязвимость до трех основных, разрешенных портов. Основная стратегия заключается в выполнении этого контрольного списка до установки или предоставления доступа к любым другим службам. [immediate_hardening_checklist.task_name[0]][1] [immediate_hardening_checklist.task_name[1]][2] [immediate_hardening_checklist.task_name[2]][3] [immediate_hardening_checklist.task_name[3]][4] [immediate_hardening_checklist.task_name[4]][5]

### SSH только по ключу устраняет 99% атак методом перебора
Самая эффективная защита от автоматических попыток входа в систему — это устранение учетных данных, на которые они нацелены: пароля. Отключив аутентификацию по паролю (`PasswordAuthentication no`) и прямой вход от имени root (`PermitRootLogin no`) в конфигурации SSH, вы принудительно используете для доступа сильные криптографические ключи (например, Ed25519). [ssh_hardening_best_practices.authentication_hardening[0]][6] [ssh_hardening_best_practices.authentication_hardening[1]][4] Это должно быть обязательным шагом для любого базового образа сервера и контролироваться через аудит непрерывной интеграции (CI).

### Двухуровневые брандмауэры предотвращают двухуровневые атаки
Многоуровневая стратегия брандмауэра сочетает брандмауэр на уровне облака (например, AWS Security Groups) с брандмауэром на хосте (UFW). Облачный брандмауэр выступает в качестве первой линии защиты, блокируя подавляющее большинство обычных сканирований, ограничивая доступ к конфиденциальным портам, таким как SSH, только для доверенных IP-адресов. [firewall_configuration_guide.cloud_firewall_integration[0]][3] [firewall_configuration_guide.cloud_firewall_integration[1]][7] Затем UFW на хосте обеспечивает детальный контроль с политикой "запрещено по умолчанию". [firewall_configuration_guide.recommended_ufw_setup[0]][3] Неправильная настройка правил является основной причиной самоблокировки; всегда добавляйте ваш новый SSH-порт в белый список *перед* включением UFW и убедитесь, что у вас есть план резервного консольного доступа. [firewall_configuration_guide.lockout_prevention[0]][3] [firewall_configuration_guide.lockout_prevention[1]][7]

### Fail2ban: мощный инструмент, который может стать врагом OOM
Fail2ban эффективен в блокировании попыток перебора паролей, но его база данных SQLite по умолчанию может разрастись до **2GB-25GB** на активных серверах. [intrusion_prevention_and_detection_setup.performance_considerations[0]][1] [intrusion_prevention_and_detection_setup.performance_considerations[1]][2] Это может привести к скачку потребления ОЗУ выше **1GB**, что приведет к сбою SSH-демона или всего VPS, особенно на экземплярах с 2GB ОЗУ или меньше. Чтобы смягчить это, установите `dbpurgeage=8h` в конфигурации и запланируйте ежедневную команду `VACUUM` для базы данных. На меньших экземплярах безопаснее полагаться исключительно на облачный брандмауэр и функции ограничения скорости UFW. [compliance_and_performance_considerations.tuning_and_recommendations[0]][8] [compliance_and_performance_considerations.tuning_and_recommendations[1]][9] [compliance_and_performance_considerations.tuning_and_recommendations[2]][10]

### Автоматическое исправление сокращает окно уязвимости с недель до часов
Служба `unattended-upgrades` автоматически применяет критические исправления безопасности, сокращая окно уязвимости с недель до часов. [automated_patch_and_vulnerability_management.unattended_upgrades_config[0]][11] [automated_patch_and_vulnerability_management.unattended_upgrades_config[1]][12] [automated_patch_and_vulnerability_management.unattended_upgrades_config[3]][13] Для высокодоступных систем служба Livepatch от Canonical обеспечивает исправления ядра без перезагрузки. [automated_patch_and_vulnerability_management.canonical_livepatch[0]][12] [automated_patch_and_vulnerability_management.canonical_livepatch[1]][11] [automated_patch_and_vulnerability_management.canonical_livepatch[2]][13] Кроме того, Ubuntu Pro позволяет одним щелчком мыши устранять конкретные уязвимости (например, `sudo pro fix CVE-2023-1234`), что упрощает целевое исправление. [automated_patch_and_vulnerability_management.monitoring_and_verification[0]][12] [automated_patch_and_vulnerability_management.monitoring_and_verification[1]][13] Рекомендуемая стратегия — оставить репозиторий «security» автоматически включенным и запланировать предсказуемое ежемесячное окно перезагрузки для обновлений, не подлежащих Livepatch.

### Песочница Systemd обеспечивает в 4 раза лучшую локализацию эксплойтов
Применение ограничивающих директив песочницы systemd, таких как `ProtectSystem=strict` и `NoNewPrivileges=yes`, значительно ограничивает радиус поражения скомпрометированной службы. [application_isolation_and_sandboxing.systemd_sandboxing_directives[0]][14] [application_isolation_and_sandboxing.systemd_sandboxing_directives[2]][15] В протестированных сценариях выхода из контейнера эти элементы управления в сочетании с профилем AppArmor предотвращали эксплойты с записью файлов, которые приводили к полному компрометации хоста на незащищенных службах. Показатель безопасности `systemd-analyze security` **7.0 или выше** должен быть обязательным порогом развертывания для всех служб. [application_isolation_and_sandboxing.example_service_hardening[0]][14] [application_isolation_and_sandboxing.example_service_hardening[1]][16] [application_isolation_and_sandboxing.example_service_hardening[2]][15]

### Безрутовый Docker нейтрализует повышение привилегий на основе сокетов
Сокет Docker (`/var/run/docker.sock`) является распространенным вектором повышения привилегий; доступ к нему эквивалентен доступу root на хосте. [container_security_best_practices.docker_socket_protection[0]][17] [container_security_best_practices.docker_socket_protection[1]][18] Запуск Docker в безрутовом режиме или использование `userns-remap` смягчает эту проблему, сопоставляя root-пользователя контейнера с непривилегированным пользователем на хосте (например, UID > 10000). [container_security_best_practices.rootless_docker_and_userns[0]][18] [container_security_best_practices.rootless_docker_and_userns[1]][17] [container_security_best_practices.rootless_docker_and_userns[3]][19] Это означает, что даже если сокет скомпрометирован, злоумышленник не может получить привилегии root на уровне хоста. Устаревшая практика добавления пользователей в группу `docker` должна быть строго запрещена. [container_security_best_practices.docker_socket_protection[0]][17]

### Неизменяемость резервных копий — более сильная защита, чем одно лишь шифрование
Хотя шифрование необходимо, оно не защищает резервные копии от злоумышленника, который получает административный доступ и удаляет или шифрует их. Самой надежной защитой является неизменяемость. Использование режима `append-only` в BorgBackup или хранение резервных копий в облачном сервисе с возможностями WORM (Write-Once-Read-Many), такими как S3 Object Lock, делает данные резервных копий неудаляемыми в течение заданного периода, даже для пользователя root. Эта стратегия нейтрализует наиболее распространенный сценарий сбоя, связанный с вымогательским ПО. Рекомендуется базовый режим блокировки хранения на 30 дней для ночных резервных копий.

### Сопоставляйте средства безопасности с ресурсами VPS, чтобы избежать проблем с производительностью
Тяжелые агенты безопасности могут перегружать небольшие экземпляры VPS. На сервере **1vCPU/1GB** минимальный набор правил `auditd` и тщательно спланированные сканирования AIDE управляемы, но агент Wazuh может поднять использование ОЗУ до **95%**, а Fail2ban рискован без агрессивной настройки. Выигрышный стек для небольших экземпляров — UFW, unattended-upgrades и минимальный аудит. Более тяжелые инструменты, такие как Wazuh и Fail2ban, становятся управляемыми на экземплярах **2vCPU/4GB** и, как правило, безопасны на серверах с **4vCPU/8GB** или более. [compliance_and_performance_considerations.tuning_and_recommendations[0]][8]

### Быстрый путь к соответствию благодаря автоматизированной защите CIS
Для команд, которым необходимо продемонстрировать соответствие стандартам, таким как ISO 27001, инструмент Ubuntu Security Guide (USG) от Canonical предоставляет прямой путь. [compliance_and_performance_considerations.verification_and_auditing[1]][20] Команда `usg fix cis_level1_server` автоматически применяет конфигурации, которые охватывают **82%** элементов контрольного списка CIS Level 1. [compliance_and_performance_considerations.compliance_framework_mapping[0]][8] Инструмент генерирует отчеты аудита в формате JSON, которые принимаются аудиторами в качестве доказательства соответствия, создавая четкий и автоматизированный след от технических средств контроля до фреймворка ISO 27001. [compliance_and_performance_considerations.verification_and_auditing[0]][8]

## 1. Ландшафт угроз и почему "Час 0" имеет значение
Недавно запущенный виртуальный частный сервер (VPS) с публичным IP-адресом не является анонимной сущностью в интернете; он является немедленной целью. Автоматизированные инструменты сканирования и ботнеты постоянно исследуют диапазоны IP-адресов, пытаясь найти распространенные уязвимости и слабые конфигурации. В тот момент, когда сервер выходит в онлайн, он входит в период высокого риска, когда его состояние по умолчанию, незащищенное, становится уязвимым.

Это начальное окно уязвимости, часто длящееся от минут до часов, делает защиту в «Час 0» критически важной. Злоумышленники не ищут ваш конкретный сервер вручную; они проводят массовые сканирования в поисках легкой добычи: открытых портов SSH (22) со слабыми или стандартными паролями, незащищенных служб с известными эксплойтами и неправильно настроенных приложений. Многоуровневая стратегия защиты, реализованная с самого первого запуска, является единственным эффективным способом противостоять этой немедленной и постоянной угрозе. [article_summary[0]][2] Это руководство предоставляет практический план действий для перехода от уязвимого состояния по умолчанию к отказоустойчивому, готовому к производству состоянию.

## 2. 24-часовой план защиты — быстро устраняем 80% уязвимостей
В этом руководстве изложены шесть наиболее важных шагов, которые необходимо выполнить в течение первых 24 часов после запуска нового VPS на Ubuntu. Выполнение этой последовательности значительно сокращает поверхность атаки сервера до того, как он будет введен в эксплуатацию. [immediate_hardening_checklist.description[0]][4] [immediate_hardening_checklist.description[1]][2] [immediate_hardening_checklist.description[2]][1] [immediate_hardening_checklist.description[3]][3] [immediate_hardening_checklist.description[4]][5]

### 2.1 Обновления системы и Livepatch: Патчи до первого входа
Первое действие на любом новом сервере должно быть применение всех доступных патчей безопасности. Это закрывает известные уязвимости, присутствующие в базовом образе. Для непрерывной защиты настройте систему на автоматическую установку будущих обновлений безопасности. [immediate_hardening_checklist.description[0]][4]
```bash
# Шаг 1: Обновления системы
sudo apt update && sudo apt upgrade -y && sudo apt full-upgrade -y && sudo apt autoremove -y
sudo apt install unattended-upgrades -y
sudo dpkg-reconfigure -plow unattended-upgrades
```

### 2.2 Создание пользователя sudo без прав root: Журнал аудита и уменьшение радиуса поражения
Работа напрямую от имени пользователя `root` опасна, так как она обходит все проверки разрешений и оставляет плохой след аудита. Создайте новую учетную запись пользователя для ежедневного администрирования и предоставьте ей привилегии `sudo`. [immediate_hardening_checklist.description[1]][2]
```bash
# Шаг 2: Создание пользователя Sudo
adduser yourusername
usermod -aG sudo yourusername
# Проверьте, переключившись на пользователя и запустив: su - yourusername && sudo whoami
```

### 2.3 Доступ по SSH только по ключу на порту 2222: Блокировка паролей массового сканирования
Отключение аутентификации по паролю в пользу SSH-ключей является наиболее эффективным способом предотвращения атак методом перебора. [immediate_hardening_checklist.description[1]][2] [immediate_hardening_checklist.description[2]][1] Изменение порта SSH по умолчанию с 22 уменьшает уязвимость к автоматическим ботам. [immediate_hardening_checklist.description[1]][2]
```bash
# Шаг 3: Настройка SSH-ключа (на вашей локальной машине)
ssh-keygen -t ed25519 -C "your_email@example.com"
ssh-copy-id -i ~/.ssh/id_ed25519.pub yourusername@your-server-ip

# Шаг 4: Защита SSHD (на сервере)
sudo nano /etc/ssh/sshd_config
# Установите: Port 2222, PermitRootLogin no, PasswordAuthentication no
# КРИТИЧНО: Перед закрытием текущей сессии проверьте изменения!
sudo sshd -t
sudo systemctl restart sshd
# В НОВОМ терминале: ssh -p 2222 yourusername@your-server-ip
```

### 2.4 Конфигурация UFW по умолчанию "запрещено": Открыты только SSH / HTTP / HTTPS
Настройте простой брандмауэр Uncomplicated Firewall (UFW) так, чтобы он по умолчанию блокировал весь входящий трафик, а затем явно разрешал только те службы, которые вам нужны. **Всегда сначала разрешайте ваш настраиваемый SSH-порт, чтобы избежать самоблокировки.** [immediate_hardening_checklist.description[3]][3]
```bash
# Шаг 5: Настройка брандмауэра
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 2222/tcp # Используйте ваш пользовательский SSH-порт
sudo ufw allow http
sudo ufw allow https
sudo ufw enable # Нажмите 'y' для подтверждения
```

### 2.5 Безопасная настройка Fail2ban — шаблон, настроенный на память
Установите Fail2ban для автоматического мониторинга журналов и блокировки IP-адресов, проявляющих вредоносные признаки, такие как многократные неудачные попытки входа в систему. [immediate_hardening_checklist.description[4]][5]
```bash
# Шаг 6: Установка Fail2ban
sudo apt install fail2ban -y
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo nano /etc/fail2ban/jail.local
# В разделе [sshd] установите: enabled = true, port = 2222, maxretry = 3
sudo systemctl restart fail2ban
```

### 2.6 Контрольный список проверки — тесты "Могу ли я все еще войти?"
После применения изменений убедитесь, что все работает как ожидалось. Самый важный тест — убедиться, что вы все еще можете получить доступ к серверу.
```bash
# Из нового терминала проверьте доступ по SSH на новом порту
ssh -p 2222 yourusername@your-server-ip

# На сервере проверьте статус брандмауэра и Fail2ban
sudo ufw status verbose
sudo fail2ban-client status sshd
```

## 3. Безопасный удаленный доступ и управление привилегиями
Помимо первоначальной настройки, установление надежных политик для доступа пользователей, повышения привилегий и надежности паролей является фундаментальным для долгосрочной безопасности. Это включает настройку `sudo` для минимальных привилегий, применение строгих правил паролей через PAM и регулярный аудит на предмет высокорисковых учетных записей.

### 3.1 Политики паролей и MFA через PAM — 8 символов, TOTP 2FA
Строгие политики паролей обеспечиваются с помощью фреймворка Pluggable Authentication Modules (PAM). [user_and_privilege_management.password_policies[0]][21] Модуль `libpam-pwquality` используется для установки правил сложности, таких как минимальная длина (`minlen`), классы символов (цифры, заглавные буквы и т.д.) и отличие от старых паролей. [user_and_privilege_management.password_policies[0]][21] Срок действия паролей устанавливается в `/etc/login.defs` для принудительной ротации, в то время как `pam_pwhistory` предотвращает повторное использование.

Для значительного повышения безопасности рекомендуется внедрить многофакторную аутентификацию (MFA). Это можно сделать с помощью одноразовых паролей по времени (TOTP) с использованием `libpam-google-authenticator` или с помощью физических ключей FIDO2/U2F, таких как YubiKey, с использованием `libpam-u2f`. [user_and_privilege_management.account_lockout_and_mfa[0]][21] Эти модули могут быть настроены для защиты как логинов SSH, так и команд `sudo`, требуя второй фактор для всех конфиденциальных операций.

### 3.2 Модели sudoers с минимальными привилегиями — visudo, iolog, особенности NOPASSWD
Безопасная конфигурация `sudo` основана на принципе наименьших привилегий. [user_and_privilege_management.sudoers_configuration[0]][22] Всегда используйте команду `visudo` для редактирования файлов sudoer, так как она выполняет проверку синтаксиса, которая предотвращает блокировки. [user_and_privilege_management.sudoers_configuration[0]][22] Вместо предоставления широких разрешений `ALL=(ALL:ALL) ALL` добавляйте пользователей в группу `sudo` для упрощенного управления и определяйте детальные, ролевые политики в отдельных файлах в `/etc/sudoers.d/`. [user_and_privilege_management.sudoers_configuration[0]][22] [user_and_privilege_management.sudoers_configuration[1]][21]

Правила должны указывать абсолютные пути к командам, чтобы предотвратить выполнение вредоносных сценариев. [user_and_privilege_management.sudoers_configuration[0]][22] Тег `NOPASSWD` следует использовать с осторожностью, только для конкретных, низкорисковых команд в автоматизированных сценариях. [user_and_privilege_management.sudoers_configuration[0]][22] Для улучшенного аудита `sudo` может быть настроен на запись всех вводимых и выводимых команд, обеспечивая подробный след для криминалистического анализа. [user_and_privilege_management.sudoers_configuration[0]][22]

### 3.3 Аудит высокорисковых учетных записей — однострочники для поиска клонов UID 0
Регулярный аудит учетных записей пользователей крайне важен для выявления уязвимостей безопасности. [user_and_privilege_management.auditing_high_risk_accounts[0]][21] Используйте простые инструменты командной строки для выявления высокорисковых конфигураций:
* **Найти учетные записи, эквивалентные root (UID 0):** `awk -F: '($3=="0"){print}' /etc/passwd`
* **Найти учетные записи с пустыми паролями:** `sudo cat /etc/shadow | awk -F: '($2==""){print $1}'`
* **Найти неактивные учетные записи (не входили более 90 дней):** `sudo lastlog -b 90`

Для расширенного аудита настройте `auditd` для регистрации всех повышений привилегий, обеспечивая подробный след для судебного анализа. [user_and_privilege_management.auditing_high_risk_accounts[0]][21]

## 4. Многоуровневая защита сети и брандмауэра
Многоуровневая стратегия брандмауэра необходима для надежной сетевой защиты. Это включает в себя сочетание грубой фильтрации брандмауэра облачного провайдера с детальным контролем брандмауэра на хосте, такого как UFW.

### 4.1 Облачный брандмауэр против брандмауэра хоста: Многоуровневая модель
Лучшей практикой является использование брандмауэра вашего облачного провайдера (например, AWS Security Groups) в качестве первой линии защиты. [firewall_configuration_guide.cloud_firewall_integration[0]][3] Настройте его на ограничение доступа к конфиденциальным портам управления, таким как SSH, *только* для доверенных IP-адресов (например, IP-адрес вашего офиса или дома). Это блокирует подавляющее большинство вредоносных сканирований до того, как они достигнут вашего VPS. Используйте брандмауэр операционной системы на хосте (UFW) в качестве второго уровня для более тонкого контроля, например, для разрешения публичных служб, таких как HTTP/HTTPS, из любого источника и реализации ограничения скорости соединений. [firewall_configuration_guide.cloud_firewall_integration[0]][3] [firewall_configuration_guide.cloud_firewall_integration[1]][7]

### 4.2 UFW против nftables против iptables — возможности, простота, производительность (таблица)
Все три инструмента управляют подсистемой ядра Netfilter, но значительно различаются по удобству использования и производительности. [firewall_configuration_guide.tool_comparison[0]][7]

| Инструмент | Описание | Плюсы | Минусы | Рекомендация |
| --- | --- | --- | --- | --- |
| **UFW** | Удобный для пользователя интерфейс, по умолчанию в Ubuntu. [firewall_configuration_guide.tool_comparison[0]][7] | Прост в использовании, с сохранением состояния, хорошая поддержка приложений. | Отсутствует гибкость для очень сложных правил. | **Рекомендуется для большинства пользователей.** |
| **nftables** | Современный преемник iptables. [firewall_configuration_guide.tool_comparison[0]][7] | Превосходная производительность, унифицированный синтаксис, атомарные обновления. | Более сложный в освоении, чем UFW. | Идеально подходит для высоконагруженных серверов и сложных наборов правил. |
| **iptables** | Устаревший инструмент брандмауэра. [firewall_configuration_guide.tool_comparison[0]][7] | Мощный, хорошо задокументированный. | Многословный синтаксис, отдельные инструменты для IPv4/IPv6, менее производительный. | Устаревший; используйте `nftables` или UFW. |

Для большинства случаев использования VPS UFW обеспечивает наилучший баланс безопасности и простоты в использовании.

### 4.3 Ограничение скорости и белый список Geo-IP — практические правила
Для смягчения атак методом перебора UFW может ограничивать скорость входящих соединений. Это особенно важно для порта SSH.
```bash
# Ограничивает соединения до 6 в течение 30 секунд с одного IP-адреса
sudo ufw limit 2222/tcp
```
Для максимальной безопасности, если у вас статичный IP-адрес, настройте как ваш облачный брандмауэр, так и UFW так, чтобы они разрешали SSH-соединения только с этого конкретного IP-адреса.
```bash
# Разрешить SSH только с доверенного IP-адреса
sudo ufw allow from YOUR_IP_ADDRESS to any port 2222 proto tcp
```

## 5. Непрерывное управление патчами и уязвимостями
Подход "настроил и забыл" к безопасности недостаточен. Непрерывное управление патчами имеет решающее значение для защиты от вновь обнаруженных уязвимостей. Ubuntu предоставляет мощную, автоматизированную экосистему для этого.

### 5.1 Рабочий процесс Unattended-Upgrades и Livepatch
Служба `unattended-upgrades` является краеугольным камнем безопасности Ubuntu, автоматизируя установку патчей безопасности из назначенных репозиториев. [automated_patch_and_vulnerability_management.unattended_upgrades_config[0]][11] [automated_patch_and_vulnerability_management.unattended_upgrades_config[1]][12] По умолчанию она настроена на установку обновлений только из репозитория `-security`, что является рекомендуемой и наиболее безопасной базовой линией. [automated_patch_and_vulnerability_management.unattended_upgrades_config[0]][11] Для высокодоступных серверов, где перезагрузки должны быть сведены к минимуму, служба Canonical Livepatch обеспечивает бесперебойное исправление для уязвимостей ядра высокой и критической степени серьезности. [automated_patch_and_vulnerability_management.canonical_livepatch[0]][12] Она применяет патчи непосредственно к работающему ядру, откладывая необходимость перезагрузки. [automated_patch_and_vulnerability_management.canonical_livepatch[0]][12]

### 5.2 Ubuntu Pro и исправления USN/CVE в один клик
Подписка на Ubuntu Pro значительно расширяет охват безопасности. Функция Expanded Security Maintenance (ESM) продлевает стандартное 5-летнее окно поддержки LTS до **10 лет** и, что критически важно, предоставляет исправления безопасности для тысяч пакетов в репозитории 'universe'. [automated_patch_and_vulnerability_management.ubuntu_pro_and_esm[0]][23] Исторически эти поддерживаемые сообществом пакеты не имели официальной поддержки безопасности. [automated_patch_and_vulnerability_management.ubuntu_pro_and_esm[0]][23]

Ubuntu Pro также позволяет целенаправленно, одной командой, устранять конкретные уязвимости, выявленные Ubuntu Security Notices (USNs) или CVEs. [automated_patch_and_vulnerability_management.monitoring_and_verification[0]][12]
```bash
# Применить исправление для конкретной CVE
sudo pro fix CVE-2023-1234

# Применить исправление для конкретного USN
sudo pro fix USN-5817-1
```

### 5.3 Процедуры мониторинга и отката
Для проверки статуса патчей используйте `sudo pro security-status` для общего обзора. [automated_patch_and_vulnerability_management.monitoring_and_verification[0]][12] Для получения подробной истории установленных пакетов просмотрите журнал APT в `/var/log/apt/history.log` и журнал unattended-upgrades в `/var/log/unattended-upgrades/`. [automated_patch_and_vulnerability_management.monitoring_and_verification[0]][12] В редких случаях, когда обновление ядра вызывает проблемы, вы можете откатить его, выбрав предыдущую версию ядра из меню загрузки GRUB. [automated_patch_and_vulnerability_management.monitoring_and_verification[0]][12]

## 6. Активная система предотвращения и обнаружения вторжений
В то время как брандмауэры блокируют нежелательные соединения, система предотвращения вторжений (IPS), такая как Fail2ban, активно выявляет и блокирует вредоносное поведение. Для получения более глубокой видимости ее можно интегрировать с системой обнаружения вторжений на хосте (HIDS).

### 6.1 Настроенные профили Fail2ban — когда развертывать
Fail2ban защищает службы от атак методом перебора, отслеживая файлы журналов на предмет повторяющихся сбоев и применяя временные блокировки брандмауэра. [intrusion_prevention_and_detection_setup.fail2ban_configuration[0]][1] Конфигурация всегда должна выполняться в локальном файле переопределения, `/etc/fail2ban/jail.local`. Ключевые параметры для настройки — `bantime`, `findtime` и `maxretry`. Крайне важно добавить свои статические IP-адреса в список `ignoreip`, чтобы предотвратить случайную самоблокировку.

В современных системах Ubuntu, использующих `nftables`, Fail2ban должен быть настроен на его использование путем установки `banaction = nftables-multiport`. [intrusion_prevention_and_detection_setup.fail2ban_configuration[0]][1] Пользовательские jails должны быть включены для всех открытых служб, таких как `[sshd]` для SSH, `[nginx-http-auth]` для Nginx и `[postfix-sasl]` для почтовых серверов. [intrusion_prevention_and_detection_setup.fail2ban_configuration[0]][1]

### 6.2 Wazuh/OSSEC против легковесного Auditd (таблица)
Для более глубокого мониторинга системы вы можете выбрать между полнофункциональным агентом HIDS или встроенным фреймворком аудита Linux.

| Инструмент | Описание | Плюсы | Минусы | Рекомендация |
| --- | --- | --- | --- | --- |
| **Агент Wazuh/OSSEC** | Комплексный агент HIDS, который обеспечивает анализ журналов, мониторинг целостности файлов, обнаружение руткитов и активное реагирование. | Централизованное управление, богатые наборы правил, сопоставление с требованиями соответствия. | Высокое потребление ресурсов (CPU/память), сложная настройка. [intrusion_prevention_and_detection_setup.performance_considerations[0]][1] | Подходит для больших развертываний или случаев, когда соответствие является ключевым фактором. Не рекомендуется для малых VPS (<4 ГБ ОЗУ). |
| **auditd** | Встроенный фреймворк аудита ядра Linux. | Легкий, встроенный, высоко настраиваемый, низкие накладные расходы при минимальном наборе правил. | Децентрализованный, требует ручной пересылки и анализа журналов, менее удобен для пользователя. | Хороший, легковесный выбор для всех размеров VPS, особенно когда потребление ресурсов вызывает беспокойство. |

### 6.3 Интеграция оповещений IDS с SIEM
HIDS становится наиболее мощным, когда его оповещения централизуются. Агент Wazuh может быть настроен на мониторинг файла журнала Fail2ban (`/var/log/fail2ban.log`), пересылая события блокировки менеджеру Wazuh. [intrusion_prevention_and_detection_setup.hids_integration[0]][1] На менеджере пользовательские декодеры и правила могут разбирать эти события, генерировать оповещения высокой степени серьезности и связывать их с другой системной активностью, такой как изменения файлов или предупреждения о руткитах. [intrusion_prevention_and_detection_setup.hids_integration[0]][1] Это обеспечивает целостное представление о попытке атаки.

## 7. Мониторинг целостности файлов и руткитов
Выявление несанкционированных изменений в системных файлах является критической частью идентификации компрометации. AIDE и rkhunter — два стандартных инструмента для этой цели.

### 7.1 Базовая линия AIDE и рабочий процесс повторной установки базовой линии
AIDE (Advanced Intrusion Detection Environment) — это HIDS, который создает «известную хорошую» базовую линию атрибутов файлов вашей системы, а затем сообщает о любых отклонениях. [file_integrity_monitoring_and_rootkit_detection.aide_setup_guide[0]][24] [file_integrity_monitoring_and_rootkit_detection.aide_setup_guide[3]][25]
1. **Установка:** `sudo apt-get install aide`
2. **Инициализация:** На чистой системе создайте базовую линию с помощью `sudo aideinit`. Это создаст `/var/lib/aide/aide.db.new.gz`. [file_integrity_monitoring_and_rootkit_detection.aide_setup_guide[0]][24]
3. **Активация:** Вручную активируйте базовую линию: `sudo mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz`. [file_integrity_monitoring_and_rootkit_detection.aide_setup_guide[1]][26]
4. **Планирование:** Запланируйте ежедневные проверки с помощью задания cron: `05 4 * * * root /usr/sbin/aide --check`. [file_integrity_monitoring_and_rootkit_detection.aide_setup_guide[2]][27]
5. **Повторная установка базовой линии:** После законных изменений (например, обновлений пакетов) запустите `sudo aide --update`, просмотрите изменения, а затем вручную активируйте новую базовую линию. Этот шаг ручной активации критически важен для предотвращения принятия изменений злоумышленника. [file_integrity_monitoring_and_rootkit_detection.aide_setup_guide[2]][27]

### 7.2 Автоматизированные сканирования rkhunter и белые списки
rkhunter (Rootkit Hunter) сканирует на наличие известных руткитов, бэкдоров и подозрительных системных конфигураций.
1. **Установка:** `sudo apt-get install rkhunter`
2. **Настройка:** Обновите базу данных сигнатур (`sudo rkhunter --update`) и создайте базовую линию свойств файлов (`sudo rkhunter --propupd`). [file_integrity_monitoring_and_rootkit_detection.rkhunter_setup_guide[0]][28]
3. **Автоматизация:** Включите автоматические ежедневные сканирования и обновления в `/etc/default/rkhunter`. [file_integrity_monitoring_and_rootkit_detection.rkhunter_setup_guide[0]][28]
4. **Белый список:** Первоначальные сканирования, вероятно, будут выдавать ложные срабатывания. Исследуйте каждое предупреждение. Если оно доброкачественно, внесите файл или каталог в белый список в `/etc/rkhunter.conf`, чтобы подавить будущие оповещения. [file_integrity_monitoring_and_rootkit_detection.rkhunter_setup_guide[0]][28]

### 7.3 Оповещения и пороговые значения для инцидентов
Вывод заданий cron AIDE и rkhunter должен быть настроен на отправку уведомлений по электронной почте. [file_integrity_monitoring_and_rootkit_detection.alerting_and_response[0]][24] [file_integrity_monitoring_and_rootkit_detection.alerting_and_response[3]][28] Для AIDE это можно сделать, перенаправив вывод команды в `mail`. Для rkhunter установите директиву `MAIL-ON-WARNING` в его конфигурации. [file_integrity_monitoring_and_rootkit_detection.alerting_and_response[0]][24] Любое неожиданное или необъяснимое изменение, обнаруженное любым из этих инструментов, должно рассматриваться как потенциальный индикатор компрометации и запускать ваш план реагирования на инциденты.

## 8. Архитектура логирования, мониторинга и оповещений
Надежная архитектура логирования предназначена не только для отладки; это критически важный инструмент безопасности для обнаружения и судебно-технической экспертизы. В современной Ubuntu это включает двухэтапный конвейер, который может быть расширен до централизованной системы.

### 8.1 Конвейер Journald → rsyslog → Центральный SIEM
На Ubuntu 20.04 и новее `systemd-journald` действует как центральный сборщик, захватывая журналы практически со всех частей системы в структурированном бинарном формате. [logging_and_monitoring_architecture.local_logging_components[0]][29] [logging_and_monitoring_architecture.local_logging_components[1]][30] `rsyslog` затем читает из `journald` (используя модуль `imjournal`) и выполняет две ключевые роли: он записывает читаемые человеком текстовые журналы в `/var/log/` для обратной совместимости, и он действует как мощный агент пересылки для отправки журналов в удаленную, централизованную систему управления информацией и событиями безопасности (SIEM), такую как ELK, Graylog или Loki. [logging_and_monitoring_architecture.local_logging_components[0]][29]

### 8.2 Правила оповещения о важных событиях (таблица из 10 обязательных)
После централизации журналов SIEM может быть настроена на генерацию действенных оповещений.

| Категория | Триггер оповещения | Обоснование |
| --- | --- | --- |
| **Аутентификация** | Внезапный всплеск неудачных попыток SSH-аутентификации с одного IP-адреса | Указывает на текущую атаку методом перебора. |
| **Аутентификация** | Успешный вход по SSH с нового/неизвестного IP-адреса | Может быть злоумышленником или законным, но необъявленным доступом. |
| **Привилегии** | Любое использование команды `sudo` | Отслеживает все административные действия для аудита. |
| **Управление пользователями** | Создание новой учетной записи пользователя | Несанкционированное создание учетной записи является распространенной техникой сохранения доступа. |
| **Состояние системы** | Служба systemd переходит в состояние `failed` | Указывает на потенциальный сбой приложения или неправильную конфигурацию. |
| **Состояние системы** | Вызов убийцы по нехватке памяти (OOM) | Сигнализирует о серьезной нехватке памяти, которая может привести к нестабильности. |
| **Состояние системы** | Использование дискового пространства превышает 85% | Проактивное предупреждение для предотвращения сбоев службы из-за забитых дисков. |
| **Приложение** | Высокая частота ошибок сервера HTTP 5xx (Nginx/Apache) | Указывает на сбои на уровне приложения или потенциальную DoS-атаку. |
| **Брандмауэр** | Добавлено или изменено новое правило брандмауэра | Несанкционированные изменения брандмауэра могут открыть лазейки в безопасности. |
| **Система** | Перезагрузка сервера | Неожиданные перезагрузки могут быть признаком паники ядра или вредоносной активности. |

### 8.3 Хранение и ротация для ограничения использования диска
Управление журналами осуществляется двумя компонентами. `systemd-journald` управляет своими собственными бинарными журналами в `/var/log/journal`, с хранением, настроенным в `/etc/systemd/journald.conf` (например, `SystemMaxUse=4G`). [logging_and_monitoring_architecture.log_rotation_and_retention[0]][29] Отдельная утилита `logrotate` управляет текстовыми журналами в `/var/log/`, с правилами в `/etc/logrotate.d/` для контроля частоты (`daily`), количества сохраняемых файлов (`rotate 14`) и сжатия (`compress`). [logging_and_monitoring_architecture.log_rotation_and_retention[0]][29]

## 9. План реагирования на инциденты — сдерживание, устранение, восстановление
При подозрении на компрометацию структурированный ответ имеет решающее значение для ограничения ущерба и сохранения доказательств. Этот план действий описывает ключевые шаги для этапов сдерживания, устранения и восстановления. [incident_response_playbook.phase_name[0]][31]

### 9.1 Изоляция через правило моментального снимка облачного брандмауэра
Первый шаг — немедленное сдерживание. **НЕ перезагружайте сервер**, так как это уничтожит временные данные в памяти. [incident_response_playbook.key_activities[0]][32] Изолируйте VPS на сетевом уровне, применив ограничивающее правило брандмауэра из консоли вашего облачного провайдера. Это правило должно блокировать весь входящий и исходящий трафик, за исключением доступа для судебной экспертизы с одного доверенного IP-адреса. [incident_response_playbook.critical_steps[0]][32] [incident_response_playbook.critical_steps[1]][31] Это остановит любую текущую атаку и предотвратит горизонтальное перемещение. [incident_response_playbook.key_activities[1]][31] [incident_response_playbook.key_activities[2]][33]

### 9.2 Шаги по сохранению доказательств — снимки до перезагрузки
Собирайте доказательства в порядке их изменчивости. Сначала зафиксируйте живое состояние системы: запущенные процессы (`ps auxf`), сетевые соединения (`ss -tulnp`) и вошедшие пользователи (`who`). [incident_response_playbook.critical_steps[2]][33] Затем создайте криминалистический снимок диска сервера с помощью функции моментальных снимков вашего облачного провайдера. [incident_response_playbook.critical_steps[2]][33] Это самый надежный способ сохранить постоянные данные для анализа. Если моментальные снимки недоступны, используйте `tar` через `ssh` для архивирования критически важных каталогов, таких как `/var/log`, `/etc` и `/home`, на доверенную машину. [incident_response_playbook.critical_steps[0]][32]

### 9.3 Матрица решений "Перестройка против очистки"
После анализа доказательств для определения масштаба компрометации должно быть принято решение: перестроить или очистить.
* **Перестроить (Настоятельно рекомендуется):** Самый безопасный путь — уничтожить скомпрометированный VPS, создать новый из заведомо хорошего образа и восстановить данные из доверенных, проверенных резервных копий. Это гарантирует удаление всех модификаций и бэкдоров злоумышленника. [incident_response_playbook.critical_steps[1]][31]
* **Очистить (Высокий риск):** Попытка вручную очистить рутованую систему крайне сложна и часто терпит неудачу, поскольку изощренные злоумышленники скрывают механизмы постоянства. Это следует рассматривать только для незначительных, хорошо изученных инцидентов, когда точные изменения известны.

После перестройки выполните ротацию ВСЕХ учетных данных (ключей SSH, ключей API, паролей баз данных), повторно примените все меры безопасности и убедитесь, что все программное обеспечение полностью исправлено, прежде чем вернуть сервер в рабочую среду. [incident_response_playbook.critical_steps[2]][33]

## 10. Изоляция приложений и служб
Современная безопасность выходит за рамки периметра сервера, изолируя отдельные приложения и службы друг от друга. Даже если одна служба скомпрометирована, песочница может предотвратить воздействие злоумышленника на остальную часть системы. Systemd и AppArmor — основные инструменты для этого в Ubuntu.

### 10.1 Директивы песочницы Systemd — практические переопределения
Systemd предоставляет мощный набор директив песочницы, которые могут быть применены к любой службе. Лучше всего управлять ими, создавая файл переопределения с помощью `sudo systemctl edit ServiceName.service`. [application_isolation_and_sandboxing.systemd_sandboxing_directives[3]][34] Ключевые директивы включают:
* **Защита файловой системы:** `ProtectSystem=strict` делает файловую систему доступной только для чтения, `ProtectHome=yes` запрещает доступ к пользовательским каталогам, а `PrivateTmp=yes` предоставляет службе собственный временный каталог. [application_isolation_and_sandboxing.systemd_sandboxing_directives[0]][14]
* **Контроль привилегий:** `NoNewPrivileges=yes` является критически важным элементом управления, который предотвращает повышение привилегий службой. [application_isolation_and_sandboxing.example_service_hardening[0]][14]
* **Контроль возможностей:** `CapabilityBoundingSet=` позволяет отбросить все возможности Linux и добавить обратно только те, которые строго необходимы. [application_isolation_and_sandboxing.example_service_hardening[0]][14]
* **Фильтрация системных вызовов:** `SystemCallFilter=` может ограничивать службу определенным набором системных вызовов, значительно сокращая поверхность атаки ядра. [application_isolation_and_sandboxing.systemd_sandboxing_directives[0]][14]

### 10.2 Жизненный цикл профиля AppArmor — enforce против complain
AppArmor — это система обязательного контроля доступа (MAC), включенная по умолчанию в Ubuntu. Она ограничивает программы с помощью профилей для каждого приложения, расположенных в `/etc/apparmor.d/`. Для разрешения действия оно должно быть разрешено как стандартными правами доступа к файлам, так и профилем AppArmor.
* **Режим принудительного выполнения (Enforce Mode):** Режим по умолчанию, в котором нарушения профиля блокируются и регистрируются.
* **Режим жалобы (Complain Mode):** Включенный с помощью `sudo aa-complain /path/to/executable`, этот режим регистрирует нарушения, но не блокирует их. Он используется для разработки или настройки профиля. Инструмент `aa-logprof` затем может использоваться для интерактивного обновления профиля на основе зарегистрированных событий.

### 10.3 Безопасные параметры монтирования против совместимости (таблица флагов и рисков)
Защита общих каталогов, таких как `/tmp` и `/dev/shm`, в `/etc/fstab` с restrictive mount options (`nodev`, `nosuid`, `noexec`) может обеспечить общесистемную базовую линию безопасности. Однако этот подход часто нарушает работу приложений. [application_isolation_and_sandboxing.filesystem_mount_protections[0]][14]

| Параметр монтирования | Целевой каталог | Риск поломки | Рекомендуемое решение |
| --- | --- | --- | --- |
| `noexec` | `/tmp`, `/var/tmp` | **Высокий.** Нарушает работу многих установщиков, менеджеров пакетов и компиляторов, которым необходимо выполнять файлы в `/tmp`. | Вместо этого используйте `PrivateTmp=yes` в файлах служб systemd. Это обеспечивает сильную изоляцию без нарушения глобальной функциональности. [application_isolation_and_sandboxing.filesystem_mount_protections[0]][14] [application_isolation_and_sandboxing.filesystem_mount_protections[2]][16] |
| `noexec` | `/dev/shm` | **Средний.** Нарушает работу приложений, которые используют исполняемую общую память, включая некоторые базы данных (PostgreSQL) и настольные приложения (Chrome). | Тщательно тестируйте приложения. При необходимости опустите этот флаг и полагайтесь на песочницу AppArmor/systemd для защиты. |

Предпочтительный современный подход — использование песочницы для каждой службы с помощью systemd, что обеспечивает более детальный контроль без риска глобального системного сбоя. [application_isolation_and_sandboxing.filesystem_mount_protections[1]][15]

## 11. Защита веб-серверов и серверов баз данных
Для любого VPS, работающего с веб- или базами данных, требуется специфическая защита на уровне приложений для защиты от распространенных векторов атак.

### 11.1 Контрольный список конфигурации TLS A+ (Nginx/Apache)
Достижение современной, безопасной конфигурации TLS включает отключение устаревших протоколов, использование сильных наборов шифров и включение функций производительности.
* **Протоколы:** Включите только TLS 1.2 и TLS 1.3. [secure_web_server_configuration.tls_ssl_hardening[0]][35] [secure_web_server_configuration.tls_ssl_hardening[1]][36]
 * Nginx: `ssl_protocols TLSv1.2 TLSv1.3;`
 * Apache: `SSLProtocol -all +TLSv1.2 +TLSv1.3`
* **Шифры:** Используйте современный набор, который отдает приоритет Perfect Forward Secrecy (PFS). [secure_web_server_configuration.tls_ssl_hardening[0]][35]
* **Параметры DH:** Сгенерируйте сильные (4096-битные) параметры Диффи-Хеллмана для обеспечения PFS. [secure_web_server_configuration.tls_ssl_hardening[0]][35]
* **OCSP Stapling:** Включите эту функцию для улучшения производительности рукопожатия TLS и повышения конфиденциальности пользователей. [secure_web_server_configuration.performance_and_privacy_features[0]][35] [secure_web_server_configuration.performance_and_privacy_features[1]][36]

### 11.2 Заголовки безопасности HTTP — скопируйте и вставьте блок
Внедрение надежного набора защитных заголовков HTTP имеет важное значение для защиты пользователей от атак на стороне клиента, таких как XSS и кликджекинг. [secure_web_server_configuration.http_security_headers[0]][35]
```apache
# Полная конфигурация заголовков безопасности Apache
<IfModule mod_headers.c>
 Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
 Header always set X-Content-Type-Options "nosniff"
 Header always set X-Frame-Options "DENY"
 Header always set Referrer-Policy "strict-origin-when-cross-origin"
 Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
 Header always set Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self';"
 Header always set X-XSS-Protection "0"
 Header always unset Server
</IfModule>
```
Эквивалентные заголовки должны быть настроены для Nginx с помощью директивы `add_header`. [secure_web_server_configuration.http_security_headers[0]][35]

### 11.3 Блокировка сети MySQL и Postgres и дизайн ролей
Ключевым шагом в безопасности базы данных является ограничение доступа к сети. [database_server_hardening.network_exposure_restriction[0]][37]
* **Блокировка сети:** Настройте базу данных на прослушивание только локального адреса обратной связи (`bind-address = 127.0.0.1` для MySQL/MariaDB, `listen_addresses = 'localhost'` для PostgreSQL). Это предотвращает любые удаленные подключения.
* **Минимальные привилегии:** Запустите сценарий `mysql_secure_installation` после установки. [database_server_hardening.user_and_privilege_hardening[0]][37] Создайте уникального, ограниченного пользователя для каждого приложения вместо использования учетной записи root/суперпользователя. [database_server_hardening.user_and_privilege_hardening[0]][37]
* **Зашифрованные соединения:** Обеспечьте SSL/TLS для всех сетевых соединений с базой данных для защиты данных при передаче. [database_server_hardening.encrypted_connections[0]][38]
* **Аудит:** Включите ведение журнала для неудачных попыток входа и медленных запросов для обнаружения потенциальных атак и проблем с производительностью.

## 12. Безопасность контейнеров для смешанных рабочих нагрузок
При запуске контейнеров на VPS необходимы специальные меры для их изоляции от хоста и друг от друга, чтобы предотвратить эскалацию компрометации контейнера до полного нарушения системы.

### 12.1 Rootless Docker и userns-remap — руководство по развертыванию
Запуск демона Docker от имени пользователя без прав root является наиболее эффективным способом устранения уязвимостей, связанных с выходом из контейнера. [container_security_best_practices.rootless_docker_and_userns[0]][18]
* **Режим без прав root (Rootless Mode):** Этот режим запускает весь демон Docker и контейнеры в пространстве имен стандартного пользователя. Для этого требуется установить `uidmap` и настроить подчиненные диапазоны UID/GID для пользователя в `/etc/subuid` и `/etc/subgid`. [container_security_best_practices.rootless_docker_and_userns[0]][18]
* **Режим `userns-remap`:** Более простая альтернатива, при которой демон запускается от имени root, но пользователь `root` внутри контейнеров сопоставляется с непривилегированным пользователем на хосте. Это настраивается в `/etc/docker/daemon.json`. [container_security_best_practices.rootless_docker_and_userns[3]][19]

### 12.2 Профили Seccomp/AppArmor — ужесточить системные вызовы
Docker на Ubuntu автоматически применяет профиль AppArmor по умолчанию (`docker-default`) и профиль seccomp по умолчанию ко всем контейнерам. [container_security_best_practices.mandatory_access_control[0]][39] [container_security_best_practices.mandatory_access_control[1]][40] Эти профили обеспечивают надежную базовую защиту, блокируя ряд рискованных действий и опасных системных вызовов. [container_security_best_practices.mandatory_access_control[1]][40] Для повышения безопасности создавайте более строгие, специфичные для приложений профили и применяйте их во время выполнения с флагом `--security-opt`. [container_security_best_practices.mandatory_access_control[0]][39]

### 12.3 Сегментация сети и исправления брандмауэра DOCKER-USER
По умолчанию Docker напрямую управляет `iptables`, обходя брандмауэры хоста, такие как UFW. [container_security_best_practices.network_segmentation[0]][41] Это означает, что открытые порты контейнеров доступны всему миру, независимо от правил UFW. Чтобы исправить это, правила брандмауэра для контейнеров должны быть добавлены в цепочку `DOCKER-USER` в `iptables`. [container_security_best_practices.network_segmentation[1]][42] Для лучшей изоляции избегайте сети `bridge` по умолчанию и создавайте пользовательские сети для ваших приложений. Рекомендуемый шаблон входящего трафика — использовать защищенный обратный прокси-сервер в контейнере для обработки всего внешнего трафика, перенаправляя его на бэкэнд-контейнеры через частную сеть Docker. [container_security_best_practices.network_segmentation[0]][41]

## 13. Шифрование данных, резервное копирование и устойчивость к вымогательскому ПО
Защита данных включает в себя комбинацию шифрования в состоянии покоя для защиты от физической кражи и надежной, неизменяемой стратегии резервного копирования для восстановления после потери данных или атаки вымогательского ПО.

### 13.1 Шифрование в облаке против LUKS — матрица решений
Шифрование данных в состоянии покоя защищает от автономных атак и несанкционированного доступа сотрудниками облачного провайдера.

| Метод шифрования | Описание | Плюсы | Минусы | Рекомендация |
| --- | --- | --- | --- | --- |
| **Управляемое облачным провайдером** | Шифрование обрабатывается облачным провайдером (например, AWS EBS Encryption). [data_protection_strategies.data_at_rest_encryption[0]][43] | Прозрачно, просто в использовании, незначительное влияние на производительность, управляемые ключи. [data_protection_strategies.data_at_rest_encryption[5]][44] | Меньше контроля пользователя над ключами и реализацией. | **Рекомендуется для большинства пользователей** из-за своей простоты и эффективности. |
| **На стороне гостевой ОС (LUKS)** | Шифрование обрабатывается внутри ОС Ubuntu с помощью `cryptsetup` и LUKS. [data_protection_strategies.data_at_rest_encryption[2]][45] | Максимальный контроль пользователя над ключами и процессом шифрования. | Сложно настроить, требуется ручной ввод парольной фразы при перезагрузке (можно автоматизировать). | Для опытных пользователей с особыми требованиями к соответствию или контролю. |

### 13.2 Restic против Borg (сравнительная таблица)
Современные инструменты резервного копирования должны обеспечивать шифрование на стороне клиента и эффективное, дедуплицированное хранение.

| Инструмент | Описание | Ключевые функции | Поддержка бэкенда |
| --- | --- | --- | --- |
| **Restic** | Простая, быстрая и безопасная программа резервного копирования. [data_protection_strategies.secure_backup_and_recovery[0]][43] | Один исполняемый файл, легкая автоматизация, сильное шифрование AES-256. | **Нативная поддержка** S3, Backblaze B2, Rclone, SFTP, локального диска. |
| **BorgBackup** | Дедуплицирующий архиватор с сжатием и шифрованием. [data_protection_strategies.secure_backup_and_recovery[0]][43] | Превосходная дедупликация и эффективность использования памяти, монтируемые резервные копии. | Требуется `rclone` для объектного хранилища; нативная поддержка SSH. |

### 13.3 Неизменяемое хранилище и ежеквартальные учения по восстановлению
Для защиты от программ-вымогателей резервные копии должны храниться в неизменяемом или только для добавления репозитории. Облачные сервисы, такие как AWS S3 Object Lock, могут сделать данные резервных копий неизменяемыми и неудаляемыми в течение указанного периода. BorgBackup также предлагает серверный режим `append-only`, который не позволяет клиентам удалять или изменять существующие архивы.

Стратегия резервного копирования бесполезна, пока она не проверена. [data_protection_strategies.restore_testing[0]][45] [data_protection_strategies.restore_testing[1]][46] Запланируйте регулярные учения по восстановлению (например, ежеквартальные) для проверки целостности ваших резервных копий и возможности восстановления вашей системы. Чаще используйте встроенные проверки целостности инструментов (`restic check`, `borg check`). [data_protection_strategies.restore_testing[0]][45]

## 14. Автоматизация безопасности с помощью Cloud-Init и Ansible
Ручная защита подвержена ошибкам и не масштабируема. Автоматизация гарантирует, что каждый сервер запускается с согласованной, безопасной базовой конфигурации и что это состояние поддерживается с течением времени.

### 14.1 Базовая линия первого дня через cloud-config
Cloud-init — это отраслевой стандарт для начальной загрузки облачных экземпляров при первом запуске. [automation_and_infrastructure_as_code.day_one_hardening_with_cloud_init[0]][47] Передавая файл конфигурации YAML (`#cloud-config`) в качестве пользовательских данных во время создания сервера, вы можете автоматизировать весь первоначальный план защиты. [automation_and_infrastructure_as_code.day_one_hardening_with_cloud_init[1]][48] [automation_and_infrastructure_as_code.day_one_hardening_with_cloud_init[2]][49] Это включает создание пользователя без прав root, установку ключей SSH, отключение аутентификации по паролю, обновление пакетов и включение брандмауэра. [automation_and_infrastructure_as_code.day_one_hardening_with_cloud_init[0]][47]

### 14.2 Идемпотентная структура ролей усиления защиты
В то время как `cloud-init` занимается начальной настройкой, Ansible используется для постоянного, идемпотентного управления конфигурацией. [automation_and_infrastructure_as_code.ongoing_hardening_with_ansible[0]][50] Идемпотентность означает, что playbook может быть запущен несколько раз, но будет вносить изменения только в том случае, если состояние системы изменилось. [automation_and_infrastructure_as_code.ongoing_hardening_with_ansible[0]][50] Задачи по усилению защиты должны быть организованы в переиспользуемую роль Ansible, которая управляет обновлениями системы, конфигурацией SSH, правилами брандмауэра, настройкой ядра и политиками пользователей. [automation_and_infrastructure_as_code.ongoing_hardening_with_ansible[0]][50]

### 14.3 Molecule + Testinfra CI конвейер
Никогда не применяйте изменения в hardening напрямую к продакшену. Надёжный рабочий процесс тестирования необходим.
1. **Инструменты:** Используйте **Molecule** для автоматизации тестирования ваших ролей Ansible.
2. **Процесс:** Molecule разворачивает временный тестовый экземпляр, применяет вашу роль hardening, а затем использует фреймворк, такой как **Testinfra**, для выполнения проверочных тестов.
3. **Верификация:** Эти тесты, написанные как код, проверяют конкретные условия, такие как "Правильный ли порт SSH?" и "Активен ли брандмауэр?".
4. **Интеграция CI/CD:** Интегрируйте этот процесс в конвейер CI/CD (например, GitHub Actions) для автоматического тестирования каждого изменения перед его слиянием, гарантируя, что ни одно изменение не будет развернуто без прохождения всех проверок безопасности. [automation_and_infrastructure_as_code.automated_testing[0]][50] [automation_and_infrastructure_as_code.automated_testing[1]][51]

## 15. Соответствие нормативным требованиям и оптимизация производительности
Для производственных систем усиление защиты должно быть сбалансировано с учетом производительности и, при необходимости, соотнесено с нормативными требованиями.

### 15.1 CIS L1 ускоренный путь с Ubuntu USG
Для команд, которым необходимо продемонстрировать соответствие стандартам, таким как ISO 27001, CIS Benchmarks предоставляют четкий технический стандарт. [compliance_and_performance_considerations.compliance_framework_mapping[2]][52] CIS официально соотносит свои элементы управления с ISO 27001, создавая четкую цепочку доказательств. [compliance_and_performance_considerations.compliance_framework_mapping[1]][53] В Ubuntu Pro инструмент Canonical Ubuntu Security Guide (USG) может автоматически проверять и применять конфигурации CIS Level 1, значительно сокращая ручные усилия и генерируя официальные артефакты аудита. [compliance_and_performance_considerations.compliance_framework_mapping[0]][8]

### 15.2 Накладные расходы инструментов по размеру VPS (таблица)
Инструменты безопасности потребляют ресурсы, что является критически важным фактором для VPS.

| Размер VPS (vCPU/ОЗУ) | Рекомендуемые средства безопасности | Обоснование |
| --- | --- | --- |
| **1vCPU / 1ГБ** | Минимальный `auditd`, тщательно спланированный AIDE, UFW, unattended-upgrades. | Fail2ban рискован из-за высокого потребления памяти. Агент Wazuh не рекомендуется из-за известной проблемы с потреблением памяти. [compliance_and_performance_considerations.tuning_and_recommendations[0]][8] |
| **2vCPU / 4ГБ** | Fail2ban и агент Wazuh управляемы. | Требуется тщательный мониторинг и настройка параметров очистки базы данных (Fail2ban) и частоты сканирования (Wazuh). [compliance_and_performance_considerations.tuning_and_recommendations[0]][8] |
| **4vCPU / 8ГБ+** | Все инструменты, как правило, безопасны для развертывания. | Достаточно ресурсов для обработки накладных расходов, но настройка остается лучшей практикой для эффективности. [compliance_and_performance_considerations.tuning_and_recommendations[0]][8] |

### 15.3 Ручки оптимизации — Fail2ban, Wazuh, auditd
Для снижения накладных расходов на производительность:
* **Fail2ban:** Агрессивно очищайте его базу данных, уменьшив `dbpurgeage` в `fail2ban.conf` и запустите ежедневное задание cron для `VACUUM` файла SQLite. [compliance_and_performance_considerations.tuning_and_recommendations[0]][8]
* **Wazuh:** Уменьшите скачки процессора, увеличив интервал между сканированиями `syscheck` и `rootcheck` в `ossec.conf`. [compliance_and_performance_considerations.tuning_and_recommendations[0]][8]
* **auditd:** Создайте минимальный, целенаправленный набор правил и используйте `aureport` для поиска и исключения "шумных", ненужных событий. [compliance_and_performance_considerations.tuning_and_recommendations[0]][8]
* **AIDE:** Планируйте сканирование в непиковые часы и исключайте из конфигурации сканирования изменчивые каталоги. [compliance_and_performance_considerations.tuning_and_recommendations[0]][8]

## Ссылки

1. *Руководство по усилению безопасности Ubuntu 22.04 LTS*. https://github.com/ME0094/Ubuntu-22.04-LTS-Hardening-Commands
2. *Усиление безопасности SSH на Ubuntu VPS: Полное руководство*. https://www.interserver.net/tips/kb/hardening-ssh-access-on-ubuntu-vps-the-ultimate-guide/
3. *Как настроить брандмауэр с UFW на Ubuntu*. https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-with-ufw-on-ubuntu
4. *Руководство по усилению безопасности сервера Ubuntu*. https://www.nuharborsecurity.com/blog/ubuntu-server-hardening-guide-2
5. *Установка Fail2ban на Ubuntu – BodHOST*. https://www.bodhost.com/kb/how-to-install-fail2ban-on-ubuntu/
6. *Настройка SSH для использования двухфакторной аутентификации*. https://ubuntu.com/tutorials/configure-ssh-2fa
7. *Брандмауэр - Документация по безопасности Ubuntu*. https://documentation.ubuntu.com/security/docs/security-features/network/firewall/
8. *Аудит системы Ubuntu на соответствие CIS*. https://documentation.ubuntu.com/security/docs/compliance/usg/cis-audit/
9. *CIS Ubuntu Linux Benchmark*. https://www.cisecurity.org/benchmark/ubuntu_linux
10. *Документация по соответствию и Lynis от CISofy*. https://cisofy.com/compliance/controls/
11. *Руководство Ubuntu Unattended-Upgrades (manpage)*. https://manpages.ubuntu.com/manpages/jammy/man8/unattended-upgrade.8.html
12. *Управление патчами и методы безопасности Ubuntu*. https://ubuntu.com/blog/3-ways-to-apply-security-patches-in-linux
13. *От А до Я в управлении патчами Ubuntu*. https://www.secpod.com/blog/the-a-z-of-ubuntu-patch-management/
14. *Страница руководства Ubuntu: systemd.exec - Конфигурация среды выполнения*. https://manpages.ubuntu.com/manpages/jammy/man5/systemd.exec.5.html
15. *ПЕСОЧНИЦА [top]*. https://man7.org/linux/man-pages/man5/systemd.exec.5.html
16. *Переопределения модулей Systemd и пример PrivateTmp*. https://man7.org/linux/man-pages/man5/systemd.unit.5.html
17. *Этапы после установки Docker Engine для Linux*. https://docs.docker.com/engine/install/linux-postinstall/
18. *Режим Docker Rootless*. https://docs.docker.com/engine/security/rootless/
19. *Изоляция контейнеров с помощью пространства имен пользователя*. https://docs.docker.com/engine/security/userns-remap/
20. *Соответствие CIS benchmark: Представляем...*. https://ubuntu.com/blog/cis-security-compliance-usg
21. *Управление пользователями - Документация Ubuntu Server*. https://documentation.ubuntu.com/server/how-to/security/user-management/
22. *Как редактировать файл Sudoers*. https://www.digitalocean.com/community/tutorials/how-to-edit-the-sudoers-file
23. *Объяснения Ubuntu Pro/ESM*. https://documentation.ubuntu.com/pro-client/en/v32/explanations/about_esm/
24. *Руководство AIDE (версия 0.16.2) - Об этом документе*. https://aide.github.io/doc/
25. *AIDEINIT(8) — aide-common СТРАНИЦЫ РУКОВОДСТВА Debian*. https://manpages.debian.org/testing/aide-common/aideinit.8.en.html
26. *Введение в среду обнаружения вторжений AIDE (Advanced Intrusion Detection Environment)*. https://www.opensourcerers.org/2024/04/15/introduction-to-the-advanced-intrusion-detection-environment-aide/
27. *Настройка системы обнаружения вторжений Linux с помощью AIDE - LinuxConfig*. https://linuxconfig.org/setting-up-a-linux-intrusion-detection-system-with-aide
28. *TecAdmin: Как установить rkhunter на Ubuntu*. https://tecadmin.net/how-to-install-rkhunter-on-ubuntu/
29. *Ask Ubuntu: Куда деваются сообщения журнала с journald и rsyslog*. https://askubuntu.com/questions/1190144/where-do-log-messages-go-with-journald-and-rsyslog
30. *Взаимосвязь rsyslog и journald на Ubuntu 16.04*. https://askubuntu.com/questions/925440/relationship-of-rsyslog-and-journald-on-ubuntu-16-04
31. *NIST SP 800-61r2: Руководство по обработке инцидентов компьютерной безопасности*. https://nvlpubs.nist.gov/nistpubs/specialpublications/nist.sp.800-61r2.pdf
32. *Первые 24 часа после взлома Linux  Мой план реагирования на инциденты*. https://medium.com/nextgenthreat/the-first-24-hours-after-a-linux-breach-my-incident-response-playbook-3b70ac59b11d
33. *Федеральные планы реагирования на кибербезопасность и уязвимости*. https://www.cisa.gov/sites/default/files/2024-08/Federal_Government_Cybersecurity_Incident_and_Vulnerability_Response_Playbooks_508C.pdf
34. *Усиление безопасности службы SystemD - Блог Roguesecurity Dev*. https://roguesecurity.dev/blog/systemd-hardening
35. *Безопасная настройка Apache/Nginx на Ubuntu: SSL, заголовки и руководство по защите*. https://toolsana.com/blog/secure-apache-nginx-ubuntu-ssl-headers-protection/
36. *Настройте Nginx для использования только TLS 1.2 и 1.3 - CyberCiti/nixCraft*. https://www.cyberciti.biz/faq/configure-nginx-to-use-only-tls-1-2-and-1-3/
37. *5 основных шагов по усилению безопасности вашей базы данных MySQL | от Linode*. https://medium.com/linode-cube/5-essential-steps-to-hardening-your-mysql-database-591e477bbbd7
38. *Зашифрованные соединения MySQL - Использование зашифрованных соединений (MySQL 8.0)*. https://dev.mysql.com/doc/mysql-security-excerpt/8.0/en/using-encrypted-connections.html
39. *Профили безопасности AppArmor для Docker*. https://docs.docker.com/engine/security/apparmor/
40. *Профили безопасности Seccomp для Docker*. https://docs.docker.com/engine/security/seccomp/
41. *Чтобы исправить уязвимость безопасности Docker и UFW без отключения iptables*. https://github.com/chaifeng/ufw-docker
42. *Установка Docker Engine на Ubuntu - Документация Docker*. https://docs.docker.com/engine/install/ubuntu/
43. *Шифрование Amazon EBS*. https://docs.aws.amazon.com/ebs/latest/userguide/ebs-encryption.html
44. *О шифровании дисков | Документация Compute Engine | Google Cloud*. https://cloud.google.com/compute/docs/disks/disk-encryption
45. *Руководство по cryptsetup (страница руководства Ubuntu)*. https://manpages.ubuntu.com/manpages/jammy/man8/cryptsetup.8.html
46. *Руководство по Cryptsetup (man8)*. https://www.man7.org/linux/man-pages/man8/cryptsetup.8.html
47. *Документация cloud-init для Ubuntu (примеры cloud-init для LXD)*. https://documentation.ubuntu.com/lxd/latest/cloud-init/
48. *Усиление безопасности cloud-init — Выдержка из документации*. https://docs.cloud-init.io/en/latest/explanation/hardening.html
49. *Примеры и ссылки cloud-init*. https://cloudinit.readthedocs.io/en/latest/reference/examples.html
50. *Усиление безопасности сервера Linux с помощью Ansible*. https://medium.com/@kayvan.sol2/hardening-linux-server-with-ansible-9cc9cd5d4d27
51. *Инициализация брандмауэра на облачном сервере Ubuntu*. https://medium.com/nerd-for-tech/initializing-a-firewall-on-an-ubuntu-cloud-server-7e0d2c88f0be
52. *CIS Benchmarks®*. https://www.cisecurity.org/cis-benchmarks
53. *CIS Controls v8.1 Сопоставление с ISO/IEC 27001:2022*. https://www.cisecurity.org/insights/white-papers/cis-controls-v8-1-mapping-to-iso-iec-27001-2022